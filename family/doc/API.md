# 家谱系统 JSON API 文档

## 综述

* API 地址：http://lymslive.top/family/japi.cgi
* 开发版 API 地址：http://lymslive.top/dev/family/japi.cgi
* 请求方式：post
* 数据格式：json，请求出响应数据格式均为 json

### 请求的一般格式

请求是一个 json 对象，其基本格式为：
```
{"api":"api_name","data":{...}}
```

* `api` 为接口名称，字符串
* `data` 为具体接口参数，嵌套 json 对象，根据不同接口名而不同，见具体接口的文档

示例，查询所有数据：
```
curl -d '{"api":"query","data":{"all":1}}'
```

### 响应的一般格式

响应也是一个 json 对象，其基本格式为：
```
{"error":0,"errmsg":"","data":{}}
```

* `error` 如果 api 操作出错，返回错误码（英文标识符），成功返回 0
* `errmsg` 如果出错，errmsg 额外给出用户友好的错误消息字符串
* `data` 如果成功，返回具体的数据对象，由具体接口决定

## 接口

支持的接口有：

* query
* create
* modify
* remove
* member_relations

其中，前面四个单个词的接口名基本增删改查接口。后面两个单词的为扩展接口，为方便
业务而专门提供的。

本节描述的接口参数，主要是上节描述的请求 data 与响应 data 的具体字段。
（部分接口，尤其是支持参数可能开发不完全，各有备注）

### 查询接口 query

#### 请求参数：req.data

* `all` 值为 `1` 时全部选择，忽略 `filter` 筛选条件，按默认选择有效数据
* `filter` 筛选条件，嵌套对象，当不存在 `all` 或为 `0` 时生效
* `page` 数值，查询第几页，默认 1
* `perpage` 数值，每页几条数据，默认 100
* `fields` 列名字符串数组，指定要查询哪些列，或默认大部分有效字段

当数组量大时，应该指定 `page` 与 `perpage` 。

默认查询字段为（另见数据库设计）：

1. `F_id` 自增编号
2. `F_name` 姓名
3. `F_sex` 性别，男 1 女 0
4. `F_level` 代际，始祖为 1 代，逐代递增，负数为配偶旁系
5. `F_father` 父亲，引用编号 id
6. `F_mother` 母亲，引用编号 id
7. `F_partner` 配偶，引用编号 id
8. `F_birthday` 生日，日期类型，yyyy-mm-dd 格式
9. `F_deathday` 忌日，日期类型，yyyy-mm-dd 格式

支持的 filter 筛选条件与数据库字段名基本类似，只是命名上没有 `F_` 前缀，且有更
多扩展：

* `id` 数值或数值数组，指定单个 id 或一组 id
* `name` 姓名
* `sex` 性别，男 1 女 0
* `level` 代际
* `father` 父亲 id
* `mother` 母亲 id
* `partner` 配偶 id

计划支持的扩展条件：

* `birthday` 日期范围，在此区间出生的，若单数值指在此之后出生的
* `deathday` 日期范围，在此区间过世的，若单数值指在此之前过世的
* `age` 年龄范围，到今天的年龄范围，若单数值指小于多少岁的
* `life` 寿命范围，特指过世的先人，若单数值指大于多少寿命的（难）

#### 响应参数：res.data

* `total` 总记录数
* `page` 当前第几页，按请求原样返回
* `perpage` 每页记录数，按请求原样返回
* `records` 查询结果 `[{}]`，记录数组，每个元素是对象，只有一条记录也是数组

默认按代际排序。在默认请求 `all` 的情况下，不会选出 `name` 为字符串 '0' 与
`level` 小于 0 的数据。前者用于标记删除，后者用于标记旁系配偶。但如果确实要选
出这类数据，可以在 `filter` 参数传入，并且不传 `all` 。

### 新建接口 create

#### 请求参数：req.data

* `id` 写定编号，否则按默认自增
* `name` 姓名
* `sex` 性别
* `father_name` 父亲姓名，通过姓名查 id，有重名或查不到时报错
* `father_id` 直接指定父亲 id ，优先级比姓名高
* `mother_name` 母亲姓名，通过姓名查 id，有重名或查不到时报错
* `mother_id` 直接指定父亲 id ，优先级比姓名高
* `partner_name` 提供配偶姓名，同时为配偶增加一条记录
* `partner_id` 提供配偶 id ，用于给已入库成员修改配偶 id
* `birthday` 生日
* `deathday` 忌日
* `requery` 重新查询插入的数据，如果请求参数含配偶信息，也返回配偶的记录

新建家庭成员记录时，必须指定一个父亲或母亲的信息，所依父/母的 id 必须先存在，
指定姓名时不应有重名。依据父母信息确定代际。

此外必须指定新增成员的姓名与性别。一般地，可同时提供配偶的姓名，则会一起将配偶
入库。若提供配偶 id ，该 id 也须事先入库，此用法只为兼容，不鼓励用，旁系配偶应
该随直系成员一起入库。也可插入新成员后再修改配偶信息，只提供配偶姓名时也会新插
入配偶记录，详见下方修改接口。

一般也无须指定新成员 id ，按默认自增即可，有特殊需求时可指定 id ，但不能与已存
在的 id 重复。

#### 响应参数：res.data

* `id` 新插入成员的 id
* `partner_id` 新增或被修改的配偶 id
* `records` 在请求了 `requery` 时返回重查的数据，1条或2条记录的数组

### 修改接口 modify

#### 请求参数：req.data

修改的请求参数与新建类似，不过 id 为必选项，根据 id 修改一条记录

* `id` 指定编号
* `name` 姓名
* `sex` 性别
* `father_name` 父亲姓名，通过姓名查 id，有重名或查不到时报错
* `father_id` 直接指定父亲 id ，优先级比姓名高
* `mother_name` 母亲姓名，通过姓名查 id，有重名或查不到时报错
* `mother_id` 直接指定父亲 id ，优先级比姓名高
* `partner_name` 提供配偶姓名，同时为配偶增加一条记录
* `partner_id` 提供配偶 id ，用于给已入库成员修改配偶 id
* `birthday` 生日
* `deathday` 忌日
* `requery` 重新查询插入的数据，如果请求参数含配偶信息，也返回配偶的记录

#### 响应参数：res.data

* `modified` 修改影响的行数
* `id` 原样返回被修改成员的 id
* `partner_id` 新增或被修改的配偶 id
* `records` 在请求了 `requery` 时返回重查的数据，1条或2条记录的数组

如果请求中不修改配偶，则也不返回 `partner_id` ，`records` 中也不包含配偶。

### 删除接口 remove

#### 请求参数：req.data

* `id` 指定编号，待删除的成员 id

#### 响应参数：res.data

* `removed` 被删除的行数，一般只请求删除一条记录的话，成功时返回 1 。

### 关系接口 member_relations

用于查询与一个成员的有亲缘关系的其他成员。

#### 请求参数：req.data

* `id` 指定基准成员 id 必填项；
* `mine` 是否查询结果也要求包含自身资料；
* `parents` 直系父（母）辈，数值表示最多上溯查多少代，-1 表示上溯到最顶层，也
  即自身代际 -1 层；
* `children` 是否查询所有直接后代，儿子或女儿
* `partner` 是否查询配偶记录
* `sibling` 是否查询同父或同母（取决于哪方是直系）的兄弟姐妹

请求参数值中，用 1/0 表示是否，0 （或不提供该参数）表示不查询这种关系。

#### 响应参数：res.data

参数字段原名返回，但除 id 外，其他指所查的记录数组，相当于查询接口的 records 。

* `id` 原样返回自身 id ；
* `mine` 一条记录的数组，自身资料；
* `parents` 记录数组，依次表示上溯祖辈的资料；
* `children` 记录数组，由自身的孩子组成；
* `partner` 记录数组，一般是一条记录，但也可能入库多次婚配的情况；
* `sibling` 记录数组，由同系兄弟姐妹组成；
